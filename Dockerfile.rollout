# Use the GCP base image with password-only SSH authentication
FROM us-west1-docker.pkg.dev/proximal-core-0/environments/base:latest

# ========================================
# Layer 1: System dependencies (rarely changes)
# ========================================

# Install specific version of protobuf compiler (29.3) - CRITICAL for fetchr schemas
RUN wget https://github.com/protocolbuffers/protobuf/releases/download/v29.3/protoc-29.3-linux-x86_64.zip && \
    unzip protoc-29.3-linux-x86_64.zip -d protoc-29.3 && \
    mv protoc-29.3/bin/protoc /usr/local/bin/ && \
    mv protoc-29.3/include/* /usr/local/include/ && \
    rm -rf protoc-29.3 protoc-29.3-linux-x86_64.zip

# ========================================
# Layer 2: Python installation (rarely changes)
# ========================================

# Install specific Python version for fetchr with proper caching
# Pre-download Python source to enable Docker layer caching
RUN eval "$(pyenv init -)" && \
    mkdir -p ~/.pyenv/cache && \
    wget -q -O ~/.pyenv/cache/Python-3.11.9.tar.xz \
    https://www.python.org/ftp/python/3.11.9/Python-3.11.9.tar.xz

# Install Python from cached source (deterministic, faster subsequent builds)
RUN eval "$(pyenv init -)" && \
    export PYTHON_BUILD_CACHE_PATH=~/.pyenv/cache && \
    CONFIGURE_OPTS="--enable-shared" PYTHON_CONFIGURE_OPTS="--enable-shared" \
    pyenv install 3.11.9 && \
    pyenv global 3.11.9

# Set permanent environment variables for fetchr's Python version
ENV PYENV_ROOT="/root/.pyenv"
ENV PATH="${PYENV_ROOT}/versions/3.11.9/bin:${PYENV_ROOT}/bin:${PATH}"

# Install Python base tools
RUN eval "$(pyenv init -)" && pip install --upgrade pip setuptools wheel

# ========================================
# Layer 3: Node.js installation (rarely changes)
# ========================================

# Install Node.js version 20.12.0 (fetchr's required version)
# We hardcode the version instead of reading from .nvmrc since we don't have the file yet
RUN . "$NVM_DIR/nvm.sh" && \
    nvm install 20.12.0 && \
    nvm alias default 20.12.0 && \
    nvm use 20.12.0 && \
    echo 'nvm use 20.12.0' >> /root/.bashrc && \
    echo "âœ… Node.js $(node --version) active" && \
    \
    npm install -g pnpm@8.6 && \
    echo "âœ… pnpm installed"

# Set Node.js PATH permanently for all subsequent commands
ENV NVM_DIR="/root/.nvm"
ENV PATH="/root/.nvm/versions/node/v20.12.0/bin:${PATH}"

# ========================================
# Layer 4: Workspace structure (rarely changes)
# ========================================

# Create workspace directory structure
RUN mkdir -p /root/workspace/backend/server \
             /root/workspace/backend/python_server \
             /root/workspace/schema \
             /root/workspace/snapshots

# ========================================
# Layer 5: Python dependencies (changes when requirements.txt changes)
# ========================================

# Copy only Python requirements files first
COPY backend/requirements.txt /root/workspace/backend/requirements.txt
COPY backend/python_server/requirements.txt /root/workspace/backend/python_server/requirements.txt

# Install main backend Python requirements
WORKDIR /root/workspace/backend
RUN eval "$(pyenv init -)" && pip install --timeout=1000 -r requirements.txt

# Install python_server specific requirements
WORKDIR /root/workspace/backend/python_server
RUN eval "$(pyenv init -)" && pip install --timeout=1000 -r requirements.txt

# ========================================
# Layer 6: Node.js dependencies (changes when package.json/lock changes)
# ========================================

# Copy package files for Node.js dependencies
COPY backend/server/package.json /root/workspace/backend/server/package.json
COPY backend/server/pnpm-lock.yaml /root/workspace/backend/server/pnpm-lock.yaml

# Install Node.js dependencies
WORKDIR /root/workspace/backend/server

# Create modified package.json without problematic postinstall script
RUN cp package.json package.json.backup && \
    node -e "const pkg = require('./package.json'); delete pkg.scripts.postinstall; require('fs').writeFileSync('package.json', JSON.stringify(pkg, null, 2));"

# Install Node dependencies using exact versions
RUN pnpm install --frozen-lockfile || pnpm install

# Restore original package.json but create a fixed version for runtime
RUN mv package.json.backup package.json && \
    node -e "const pkg = require('./package.json'); pkg.scripts.postinstall = 'echo \"Python deps already installed during build, skipping postinstall\"'; require('fs').writeFileSync('package.json', JSON.stringify(pkg, null, 2));"

# ========================================
# Layer 7: Source code and build (changes frequently)
# ========================================

# Now copy all source code
COPY . /root/workspace/

# Generate protocol buffers (schema should be at ../../schema from here)
WORKDIR /root/workspace/backend/server
RUN if [ -d "../../schema" ]; then \
        mkdir -p src/proto && \
        protoc --experimental_allow_proto3_optional \
               --plugin=protoc-gen-ts_proto=./node_modules/.bin/protoc-gen-ts_proto \
               --ts_proto_out=src/proto \
               --ts_proto_opt=outputServices=generic-definitions,outputServices=nice-grpc,outputClientImpl=false,oneof=unions,snakeToCamel=true,esModuleInterop=true,lowerCaseServiceMethods=true,useExactTypes=true,outputPartialMethods=false \
               --proto_path=../../schema \
               ../../schema/**/*.proto || echo "Proto generation failed, continuing..."; \
    fi

# Generate Prisma client (if schema.prisma exists)
RUN if [ -f "schema.prisma" ]; then \
        pnpm run prisma:generate || echo "Prisma generation failed, continuing..."; \
    fi

# Build the project
RUN pnpm run build || echo "Build failed, continuing for debugging..."

# ========================================
# Layer 8: Runtime setup (rarely changes)
# ========================================

# Go back to workspace root for task execution
WORKDIR /root/workspace

# Create a simple helper script for interactive development
RUN echo '#!/bin/bash' > /usr/local/bin/fetchr-dev && \
    echo 'cd /root/workspace' >> /usr/local/bin/fetchr-dev && \
    echo 'echo "ðŸš€ Fetchr development environment ready!"' >> /usr/local/bin/fetchr-dev && \
    echo 'echo "   Node: $(node --version) | Python: $(python --version) | pnpm: $(pnpm --version)"' >> /usr/local/bin/fetchr-dev && \
    echo 'bash "$@"' >> /usr/local/bin/fetchr-dev && \
    chmod +x /usr/local/bin/fetchr-dev

# Expose essential ports (fetchr app ports only)
# Redis (6380) and PostgreSQL (5432) will be handled by infrastructure components
EXPOSE 22 3000 9091 8003 9901

# CMD inherited from base image - starts SSH + MCP server